<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å²›ä¸»åˆ«è·‘ï¼šæœ€å72å°æ—¶ (å•æœºç‰ˆ)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Fredoka+One&family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'pop-cream': '#FDF6E3',
              'pop-yellow': '#FFD166',
              'pop-red': '#EF476F',
              'pop-green': '#06D6A0',
              'pop-blue': '#118AB2',
              'pop-dark': '#073B4C',
            },
            fontFamily: {
              cartoon: ['"Bangers"', 'cursive'],
              rounded: ['"Fredoka One"', 'cursive'],
              sans: ['"Noto Sans SC"', 'sans-serif'],
            },
            boxShadow: {
              'pop': '4px 4px 0px 0px #000000',
              'pop-lg': '8px 8px 0px 0px #000000',
              'pop-sm': '2px 2px 0px 0px #000000',
            },
            animation: {
              'bounce-fast': 'bounce 0.5s infinite',
              'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite',
              'jelly': 'jelly 0.5s',
              'float': 'float 3s ease-in-out infinite',
              'danmaku': 'danmaku 10s linear infinite',
              'spin-slow': 'spin 8s linear infinite',
              'fade-in': 'fadeIn 0.5s ease-out',
            },
            keyframes: {
              shake: {
                '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
              },
              jelly: {
                '0%, 100%': { transform: 'scale(1, 1)' },
                '25%': { transform: 'scale(0.9, 1.1)' },
                '50%': { transform: 'scale(1.1, 0.9)' },
                '75%': { transform: 'scale(0.95, 1.05)' }
              },
              danmaku: {
                '0%': { transform: 'translateX(100%)' },
                '100%': { transform: 'translateX(-100%)' }
              },
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' }
              }
            }
          }
        }
      }
    </script>

    <!-- 2. Dependencies (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        background-color: #FDF6E3;
        color: #073B4C;
        overflow: hidden;
        touch-action: manipulation;
        font-family: "Noto Sans SC", sans-serif;
      }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #FDF6E3; border-left: 2px solid #000; }
      ::-webkit-scrollbar-thumb { background: #FFD166; border: 2px solid #000; border-radius: 0; }
      ::-webkit-scrollbar-thumb:hover { background: #EF476F; }
      .marquee {
        display: inline-block;
        animation: marquee 15s linear infinite;
        padding-left: 100%;
      }
      @keyframes marquee {
        0% { transform: translate(0, 0); }
        100% { transform: translate(-100%, 0); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect } = React;
      const { AreaChart, Area, ResponsiveContainer } = Recharts;
      
      // Destructure Icons
      const { 
        Play, Settings, Clock, Heart, Brain, RefreshCw,
        LogOut, X, Zap, Database, Siren, ArrowLeft,
        DollarSign, Eye, Sun, Users, Scale
      } = lucideReact;

      // ==========================================
      // 1. TYPES & ENUMS
      // ==========================================
      
      enum GamePhase {
        START = 'START',
        TALENT_SELECT = 'TALENT_SELECT',
        GAME_LOOP = 'GAME_LOOP',
        GAME_OVER = 'GAME_OVER',
        TALENT_INDEX = 'TALENT_INDEX',
      }

      enum TalentType {
        SURVIVAL = 'SURVIVAL',
        RESOURCE = 'RESOURCE',
        SOCIAL = 'SOCIAL',
        TIME = 'TIME',
        SKILL = 'SKILL',
        SPECIAL = 'SPECIAL',
      }

      // ==========================================
      // 2. DATA
      // ==========================================

      const TALENTS = [
        { id: 'T01', name: 'é“èƒƒ', type: TalentType.SURVIVAL, rarity: 'RARE', description: 'åœ¨ä¸›æ—èƒ½åƒé’è›™ï¼Œåœ¨è´«æ°‘çªŸèƒ½åƒè¿‡æœŸç½å¤´ã€‚é£Ÿç‰©ç±»äº‹ä»¶å›è¡€ç¿»å€ï¼Œå…ç–«ä¸­æ¯’ã€‚' },
        { id: 'T02', name: 'ç‘å£«æˆ·å£', type: TalentType.RESOURCE, rarity: 'LEGENDARY', description: 'åˆå§‹èµ„é‡‘ $500wã€‚è™½ç„¶è´¦æˆ·å¸¸è¢«å†»ç»“ï¼Œä½†ç˜¦æ­»çš„éª†é©¼æ¯”é©¬å¤§ã€‚' },
        { id: 'T03', name: 'ç½‘çº¢ä½“è´¨', type: TalentType.SOCIAL, rarity: 'COMMON', description: 'å‘æ¨ç‰¹æ•ˆæœç¿»å€ã€‚åœ¨è¿™ä¸ªæµé‡ä¸ºç‹çš„æ—¶ä»£ï¼Œé»‘çº¢ä¹Ÿæ˜¯çº¢ã€‚' },
        { id: 'T04', name: 'åœ°å ¡å»ºç­‘å¸ˆ', type: TalentType.SKILL, rarity: 'RARE', description: 'åœ¨åœ°å ¡ (Route C) ä¸­ï¼Œç†æ™ºæ¶ˆè€—å‡åŠï¼Œä¸”èƒ½å‘ç°éšè—çš„ç‰©èµ„ã€‚' },
        { id: 'T05', name: 'è€å®äºº', type: TalentType.SOCIAL, rarity: 'COMMON', description: 'å®¹æ˜“è¢«è¯ˆéª—(é‡‘é’±æŸå¤±+20%)ï¼Œä½†åœ¨ç»è¿‡æ£€æŸ¥ç«™/ç›˜é—®æ—¶ï¼Œé€šè¿‡ç‡å¤§å¹…æå‡ã€‚' },
        { id: 'T06', name: 'é»‘å®¢å¸å›½', type: TalentType.SKILL, rarity: 'LEGENDARY', description: 'ç²¾é€šåŠ å¯†è´§å¸å’Œç½‘ç»œæˆ˜ã€‚è§£é”æ‰€æœ‰â€œç”µå­/ç½‘ç»œâ€äº‹ä»¶çš„éšè—é€‰é¡¹ã€‚' },
        { id: 'T07', name: 'æ—¶é—´ç®¡ç†', type: TalentType.TIME, rarity: 'RARE', description: 'æ‰€æœ‰æ¶ˆè€—æ—¶é—´çš„äº‹ä»¶ï¼Œæ—¶é—´æ¶ˆè€—å‡å°‘ 0.5hã€‚é€ƒäº¡ä¹Ÿè¦è®²æ•ˆç‡ã€‚' },
        { id: 'T08', name: 'ç”šè‡³è¿å·', type: TalentType.SOCIAL, rarity: 'COMMON', description: 'ä½ çš„ç”µè¯å·ç å¤ªå°Šè´µã€‚è¯ˆéª—çŸ­ä¿¡ä¼šå˜æˆé€é’±äº‹ä»¶ï¼Œä½†å®¹æ˜“è¢«å®šä½ã€‚' },
        { id: 'T09', name: 'è¢«è¿«å®³å¦„æƒ³', type: TalentType.SKILL, rarity: 'COMMON', description: 'åŸºç¡€æ›å…‰åº¦+10%ï¼Œä½†èƒ½æå‰çœ‹è§é€‰é¡¹çš„é£é™©å€¼ (Risk)ã€‚' },
        { id: 'T10', name: 'å‰ç‰¹ç§å…µ', type: TalentType.SKILL, rarity: 'RARE', description: 'æˆ˜æ–—/çªå›´äº‹ä»¶å¿…å®šæˆåŠŸï¼Œä¸”ä¸æ‰£å¥åº·å€¼ã€‚' },
        { id: 'T11', name: 'æ¼”è¯´å®¶', type: TalentType.SOCIAL, rarity: 'LEGENDARY', description: 'åªè¦ç†æ™ºå°šå­˜ï¼Œä½ å°±èƒ½å¿½æ‚ ä»»ä½•äººã€‚ç¤¾äº¤ç±»äº‹ä»¶æ”¶ç›Šç¿»å€ã€‚' },
        { id: 'T12', name: 'å†·è¡€åŠ¨ç‰©', type: TalentType.SPECIAL, rarity: 'RARE', description: 'æ— è®ºå‘ç”Ÿä»€ä¹ˆæ‚²å‰§ï¼Œç†æ™ºéƒ½ä¸ä¼šæ‰£é™¤è¶…è¿‡ 5 ç‚¹ã€‚' },
      ];

      const EVENTS = [
        {
          id: 'U01_HUNGRY',
          title: 'æ¼«é•¿çš„ç­‰å¾…',
          description: 'æš‚æ—¶æ²¡æœ‰çªå‘çŠ¶å†µã€‚ä½ èº²åœ¨è§’è½é‡Œï¼Œè‚šå­å¼€å§‹å’•å’•å«ã€‚æ—¶é—´çš„æµé€è®©ä½ æ„Ÿåˆ°ç„¦è™‘ã€‚',
          tags: ['SURVIVAL', 'TIME'],
          priority: 0, 
          repeatable: true,
          choices: [
            {
              text: 'åŸåœ°ä¼‘æ¯',
              type: 'SAFE',
              healthCost: -2, 
              sanityCost: 2,
              effect: (s) => ({ time: s.time - 1, health: s.health + 2, sanity: s.sanity - 2 }),
              resultText: 'ä½ é—­ç›®å…»ç¥äº†ä¸€ä¼šå„¿ã€‚ä½“åŠ›æ¢å¤äº†äº›è®¸ï¼Œä½†ç„¦è™‘æ„ŸåŠ é‡äº†ã€‚',
            },
            {
              text: 'ç¿»çœ‹æ—§ç…§ç‰‡',
              type: 'NORMAL',
              effect: (s) => ({ time: s.time - 1, sanity: s.sanity + 5 }),
              resultText: 'ä½ çœ‹ç€ä»¥å‰é˜…å…µçš„ç…§ç‰‡ï¼Œé‚£æ˜¯ä½ é€å»çš„é’æ˜¥ã€‚',
            }
          ]
        },
        {
          id: 'E100_START',
          title: 'æœ€å72å°æ—¶',
          description: 'è­¦æŠ¥æ‹‰å“ï¼Œæ€»ç»Ÿåºœä¹±ä½œä¸€å›¢ã€‚åŠå…¬æ¡Œä¸Šåªæœ‰ä¸‰æ ·ä¸œè¥¿èƒ½å¸¦èµ°ï¼Œè¿™å†³å®šäº†ä½ çš„é€ƒäº¡è·¯çº¿ã€‚',
          tags: ['CITY', 'DANGER'],
          priority: 100,
          condition: (s) => s.time === 72,
          choices: [
            {
              text: 'é˜²å¼¹å¥”é©°è½¦é’¥åŒ™',
              type: 'AGGRESSIVE',
              setRoute: 'A',
              effect: (s) => ({ time: s.time - 1, risk: 20 }),
              resultText: 'ä½ é€‰æ‹©äº†ã€Route A: è´«æ°‘çªŸä¹‹ç‹ã€‘ã€‚ç›®æ ‡ï¼šåˆ©ç”¨æ°‘æ„å’Œé»‘å¸®ï¼Œåœ¨æ··ä¹±ä¸­éšèº«ã€‚',
            },
            {
              text: 'æ—§å†›é´å’Œç åˆ€',
              type: 'STEALTH',
              healthCost: 5,
              setRoute: 'B',
              effect: (s) => ({ time: s.time - 1, health: s.health - 5 }),
              resultText: 'ä½ é€‰æ‹©äº†ã€Route B: ä¸›æ—æ³•åˆ™ã€‘ã€‚ç›®æ ‡ï¼šç©¿è¶Šè¾¾é‡Œæ©åœ°å ‘ï¼Œæ´»å¾—åƒä¸ªé‡å…½ã€‚',
            },
            {
              text: 'æ ¸æ‰‹æç®±',
              type: 'SPECIAL',
              sanityCost: 10,
              setRoute: 'C',
              effect: (s) => ({ time: s.time - 1, sanity: s.sanity - 10 }),
              resultText: 'ä½ é€‰æ‹©äº†ã€Route C: åœ°å ¡æš´å›ã€‘ã€‚ç›®æ ‡ï¼šæ­»å®ˆåœ°ä¸‹æ©ä½“ï¼Œç­‰å¾…ä¸å­˜åœ¨çš„æ´å†›ã€‚',
            }
          ]
        },
        {
          id: 'G01_MUSK',
          title: 'é©¬æ–¯å…‹çš„å˜²è®½',
          description: 'åŸƒéš†Â·é©¬æ–¯å…‹åœ¨Xä¸Šå‘äº†ä¸€å¼ ä½ è¢«PSæˆå°ä¸‘çš„è¡¨æƒ…åŒ…ï¼Œé…æ–‡â€œDOGE coin is more stable than his regimeâ€ï¼ˆç‹—ç‹—å¸éƒ½æ¯”ä»–çš„æ”¿æƒç¨³ï¼‰ã€‚',
          tags: ['DIGITAL', 'SOCIAL'],
          choices: [
            {
              text: 'å¯¹å–·',
              type: 'AGGRESSIVE',
              effect: (s) => ({ risk: s.risk + 10, fans: s.fans + 50000, time: s.time - 1 }),
              resultText: 'ä½ å›äº†ä¸€å¥è„è¯ã€‚è™½ç„¶æš´éœ²äº†IPï¼Œä½†ä½ çš„ç²‰ä¸æ•°æš´æ¶¨ã€‚é»‘çº¢ä¹Ÿæ˜¯çº¢ã€‚',
            },
            {
              text: 'é»˜é»˜æ‹‰é»‘',
              type: 'SAFE',
              sanityCost: 5,
              effect: (s) => ({ sanity: s.sanity - 5, time: s.time - 0.5 }),
              resultText: 'ä½ å…³æ‰äº†å±å¹•ã€‚è¿™ä¸€åˆ»ï¼Œä½ æ„Ÿåˆ°äº†å‰æ‰€æœªæœ‰çš„å­¤ç‹¬ã€‚',
            }
          ]
        },
        {
          id: 'G02_DEEPFAKE',
          title: 'AI æ¢è„¸è¯ˆéª—',
          description: 'ä½ åœ¨TikTokä¸Šåˆ·åˆ°äº†â€œè‡ªå·±â€çš„ç›´æ’­ã€‚AIç”Ÿæˆçš„ä½ åœ¨é•œå¤´å‰å“­ç€æ¨é”€â€œæµäº¡è€…â€ç‰Œæ´—å‘æ°´ã€‚å±…ç„¶æœ‰ä¸‰ä¸‡äººä¸‹å•ã€‚',
          tags: ['DIGITAL', 'SCAM'],
          choices: [
            {
              text: 'è¿™ä¹Ÿè¡Œï¼Ÿæˆ‘ä¹Ÿå–ï¼',
              type: 'NORMAL',
              sanityCost: 5,
              effect: (s) => ({ money: s.money + 50000, risk: s.risk + 15, sanity: s.sanity - 5 }),
              resultText: 'ä½ åŠ å…¥äº†å¸¦è´§è¡Œåˆ—ã€‚çœŸå‡ç¾çŒ´ç‹åŒæ—¶åœ¨çº¿ï¼Œè§‚ä¼—ç›´å‘¼è¿‡ç˜¾ã€‚',
            },
            {
              text: 'æ„Ÿåˆ°å­˜åœ¨ä¸»ä¹‰å±æœº',
              type: 'SAFE',
              sanityCost: 10,
              effect: (s) => ({ sanity: s.sanity - 10, risk: Math.max(0, s.risk - 5) }),
              resultText: 'å¦‚æœæ˜¯AIåœ¨æ›¿æˆ‘åç‰¢å°±å¥½äº†ã€‚ä½ é™·å…¥äº†æ²‰æ€ã€‚',
            }
          ]
        },
        {
          id: 'G03_KFC',
          title: 'ç–¯ç‹‚æ˜ŸæœŸå››',
          description: 'ä»Šå¤©æ˜¯å‘¨å››ã€‚è·¯è¾¹åƒåœ¾æ¡¶ä¸Šçš„å¹¿å‘Šå•å†™ç€ï¼šâ€œVæˆ‘50ï¼ŒåŠ©ä½ å¤å›½â€ã€‚ä½ æ›¾æ˜¯è¿™ä¸ªå›½å®¶çš„ç‰¹è®¸ç»è¥æƒæ‹¥æœ‰è€…ã€‚',
          tags: ['FOOD', 'CITY'],
          choices: [
            {
              text: 'æƒ³åƒï¼Œä¹°ä¸èµ·',
              type: 'NORMAL',
              healthCost: 5,
              sanityCost: 5,
              effect: (s) => ({ sanity: s.sanity - 5, health: s.health - 5 }),
              resultText: 'ä½ è¿ä¸ªè›‹æŒéƒ½ä¹°ä¸èµ·ã€‚é¥¥é¥¿æ„Ÿè®©ä½ æ›´åŠ æ¸…é†’åœ°è®¤è¯†åˆ°äº†é˜¶çº§è·Œè½ã€‚',
            },
            {
              text: '[é“èƒƒ] ç¿»åƒåœ¾æ¡¶',
              type: 'TALENT',
              talentReq: 'T01',
              effect: (s) => ({ health: s.health + 10, sanity: s.sanity + 5 }),
              resultText: 'ä½ æ‰¾åˆ°åŠä¸ªå…¨å®¶æ¡¶ã€‚è™½ç„¶å‡‰äº†ï¼Œä½†è¿™æ˜¯ä½ ä¸‰å¤©æ¥åƒå¾—æœ€å¥½çš„ä¸€é¡¿ã€‚',
            }
          ]
        },
        {
          id: 'G05_STARLINK',
          title: 'æ˜Ÿé“¾è¿‡å¢ƒ',
          description: 'æŠ¬å¤´çœ‹å¤œç©ºï¼Œä¸€ä¸²æ˜Ÿé“¾å«æ˜Ÿåƒå¹½çµç«è½¦ä¸€æ ·åˆ’è¿‡ã€‚ä½ çŸ¥é“å®ƒä»¬æ­£åœ¨æ‰«æåœ°é¢çš„çƒ­æºä¿¡å·ã€‚',
          tags: ['SKY', 'DANGER'],
          choices: [
            {
              text: 'æ³¼ç­ç¯ç«',
              type: 'STEALTH',
              healthCost: 5,
              effect: (s) => ({ health: s.health - 5, risk: Math.max(0, s.risk - 10) }),
              resultText: 'å¯’å†·åˆºéª¨ï¼Œä½†è‡³å°‘ä½ ä»çƒ­æˆåƒä¸Šæ¶ˆå¤±äº†ã€‚',
            },
            {
              text: 'ç«–ä¸­æŒ‡',
              type: 'AGGRESSIVE',
              effect: (s) => ({ sanity: s.sanity + 5, risk: s.risk + 5 }),
              resultText: 'è™½ç„¶å«æ˜Ÿçœ‹ä¸è§ï¼Œä½†ä½ å¿ƒé‡Œçˆ½å¤šäº†ã€‚',
            }
          ]
        },
        // ROUTE A
        {
          id: 'A02_CAR_MOD',
          title: 'éæ³•æ”¹è£…',
          description: 'è´«æ°‘çªŸçš„æœºæ¢°å¸ˆè¦æŠŠä½ çš„é˜²å¼¹å¥”é©°æ‹†äº†å–åºŸé“ã€‚ä½ ä¸å¾—ä¸ç­”åº”è®©ä»–æŠŠè½¦é¡¶çš„æœºæªæ”¹æˆçƒ¤è‚‰æ¶ï¼Œä»¥æ­¤æ¢å–ä¿æŠ¤ã€‚',
          tags: ['MECH', 'CITY'],
          route: 'A',
          choices: [
            {
              text: 'åŒæ„æ”¹è£…',
              type: 'NORMAL',
              effect: (s) => ({ money: s.money + 20000, risk: Math.max(0, s.risk - 10) }),
              resultText: 'è¿™è¾†æ›¾ç»è±¡å¾æƒåŠ›çš„è½¦ï¼Œç°åœ¨å˜æˆäº†å…¨åŸæœ€ç«çš„æµåŠ¨çƒ§çƒ¤æ‘Šã€‚',
            },
            {
              text: 'æˆ‘æ˜¯æ€»ç»Ÿï¼',
              type: 'AGGRESSIVE',
              healthCost: 20,
              effect: (s) => ({ health: s.health - 20, risk: s.risk + 20 }),
              resultText: 'æœºæ¢°å¸ˆç»™äº†ä½ ä¸€æ‰³æ‰‹ã€‚â€œè¿™é‡Œåªæœ‰åºŸé“ï¼Œæ²¡æœ‰æ€»ç»Ÿã€‚â€',
            }
          ]
        },
        {
          id: 'A03_YOUTUBER',
          title: 'ç½‘çº¢æ‰“å¡ç‚¹',
          description: 'å‡ ä¸ªä¸æ€•æ­»çš„æ¬§ç¾ YouTuber æºœè¿›è´«æ°‘çªŸåšç›´æ’­ï¼Œæ ‡é¢˜æ˜¯â€œå¯»æ‰¾ä¼ è¯´ä¸­çš„å¤§èƒ¡å­â€ã€‚',
          tags: ['DIGITAL', 'DANGER'],
          route: 'A',
          choices: [
            {
              text: 'èº²è¿›ä¸‹æ°´é“',
              type: 'STEALTH',
              healthCost: 5,
              sanityCost: 10,
              effect: (s) => ({ health: s.health - 5, sanity: s.sanity - 10, risk: Math.max(0, s.risk - 10) }),
              resultText: 'ä½ å’Œè€é¼ å¤§çœ¼çªå°çœ¼ã€‚å¤–é¢ä¼ æ¥ä¸»æ’­å…´å¥‹çš„å£°éŸ³ï¼šâ€œå®¶äººä»¬ï¼Œåˆ·æ¸¸è‰‡æˆ‘è¿›å»çœ‹çœ‹ï¼â€',
            },
            {
              text: 'æ”¶è´¹åˆå½±',
              type: 'NORMAL',
              effect: (s) => ({ money: s.money + 5000, risk: s.risk + 30, fans: s.fans + 10000 }),
              resultText: 'ä½ æˆ´ä¸Šå¢¨é•œæ”¶äº†5000åˆ€ã€‚ç›´æ’­é—´ç‚¸äº†ï¼ŒCIAçš„å®šä½ä¹Ÿé”å®šäº†è¿™é‡Œã€‚',
            }
          ]
        },
        {
          id: 'A04_GANG',
          title: 'å¸®æ´¾è°ˆåˆ¤',
          description: 'å½“åœ°å¸®æ´¾è€å¤§â€œç–¯ç‹—â€æ‰¾åˆ°äº†ä½ ã€‚ä»–è¡¨ç¤ºå¦‚æœä½ èƒ½æŠŠä»–åˆ—å…¥æœªæ¥çš„â€œç‰¹èµ¦åå•â€ï¼Œä»–å°±å¸®ä½ æå®šä»Šæ™šçš„å·¡é€»é˜Ÿã€‚',
          tags: ['HUMAN', 'DANGER'],
          route: 'A',
          choices: [
            {
              text: 'æˆäº¤',
              type: 'AGGRESSIVE',
              effect: (s) => ({ fans: s.fans - 5000, risk: Math.max(0, s.risk - 20), karma: s.karma - 20 }),
              resultText: 'ä½ å‡ºå–äº†æ­£ä¹‰ï¼ˆè™½ç„¶ä½ ä¹Ÿæ²¡å¤šå°‘ï¼‰ï¼Œæ¢æ¥äº†ä»Šæ™šçš„å¹³å®‰ã€‚',
            },
            {
              text: 'æ‹’ç»',
              type: 'NORMAL',
              healthCost: 20,
              effect: (s) => ({ health: s.health - 20, sanity: s.sanity + 10 }),
              resultText: 'ä½ è¢«æ‰“äº†ä¸€é¡¿ï¼Œä½†å®ˆä½äº†åº•çº¿ã€‚è™½ç„¶åº•çº¿ä¸èƒ½å½“é¥­åƒã€‚',
            }
          ]
        },
        // ROUTE B
        {
          id: 'B01_COYOTE',
          title: 'è›‡å¤´çš„æ¶¨ä»·',
          description: 'å¸¦è·¯çš„è›‡å¤´æŠŠçƒŸå¤´å¼¹åœ¨åœ°ä¸Šï¼šâ€œç°åœ¨ä½ æ˜¯VIPå®¢æˆ·ï¼Œå¾—åŠ é’±ã€‚ä½ çš„äººå¤´æ¯”æ¯’å“å€¼é’±å¤šäº†ã€‚â€',
          tags: ['HUMAN', 'MONEY'],
          route: 'B',
          choices: [
            {
              text: 'æ”¯ä»˜åŠ ä»· ($50w)',
              type: 'NORMAL',
              moneyReq: 500000,
              effect: (s) => ({ money: s.money - 500000, time: s.time - 1 }),
              resultText: 'ä½ æ”¯ä»˜äº†è¿™ç¬”å·¨æ¬¾ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§é€šè´§è†¨èƒ€ã€‚',
            },
            {
              text: '[ç‰¹ç§å…µ] ç‰©ç†è®²ä»·',
              type: 'TALENT',
              talentReq: 'T10',
              effect: (s) => ({ money: s.money + 10000, risk: s.risk - 5 }),
              resultText: 'ä½ å¤ºè¿‡ä»–çš„æªï¼Œä¸ä»…å…äº†å•ï¼Œè¿˜åå‘æ‰“åŠ«äº†ä»–èº«ä¸Šçš„ç°é‡‘ã€‚',
            }
          ]
        },
        {
          id: 'B02_MUD',
          title: 'è¾¾é‡Œæ©çš„æ³¥æ²¼',
          description: 'ä½ é™·è¿›äº†é½è…°æ·±çš„æ³¥æ²¼ã€‚å¦‚æœä»¥å‰ï¼Œä¼šæœ‰åä¸ªä¿é•–è¶´åœ¨åœ°ä¸Šç»™ä½ å½“æ¡¥ã€‚ç°åœ¨ï¼Œä½ åªèƒ½æŠ“ä½ä¸€æ ¹çœ‹èµ·æ¥åƒæ¯’è›‡çš„æ ‘æã€‚',
          tags: ['SURVIVAL', 'NATURE'],
          route: 'B',
          choices: [
            {
              text: 'æŒ£æ‰çˆ¬å‡º',
              type: 'NORMAL',
              healthCost: 15,
              effect: (s) => ({ health: s.health - 15, time: s.time - 2 }),
              resultText: 'ä½ åƒåªæ³¥çŒ´ä¸€æ ·çˆ¬äº†å‡ºæ¥ã€‚ä½ çš„ä¸€åªæ„å¤§åˆ©å®šåˆ¶çš®é‹æ°¸è¿œç•™åœ¨äº†é‚£é‡Œã€‚',
            },
            {
              text: 'å‘¼å«éšè¡Œéš¾æ°‘',
              type: 'SOCIAL',
              moneyReq: 5000,
              effect: (s) => ({ money: s.money - 5000, fans: s.fans - 100 }),
              resultText: 'ä½ èŠ±é’±é›‡äººæŠŠä½ æ‹‰äº†å‡ºæ¥ã€‚ä»–ä»¬çœ‹ä½ çš„çœ¼ç¥å……æ»¡äº†é„™è§†ã€‚',
            }
          ]
        },
        {
          id: 'B04_FOOD',
          title: 'ä¸›æ—é‡å‘³',
          description: 'å¹²ç²®åƒå®Œäº†ã€‚ä½ æŠ“åˆ°ä¸€åªè‰²å½©æ–‘æ–“çš„é’è›™ã€‚æ ¹æ®è´çˆ·çš„èŠ‚ç›®ï¼Œè¿™ç©æ„å„¿å»æ‰å¤´åº”è¯¥èƒ½åƒã€‚',
          tags: ['FOOD', 'NATURE'],
          route: 'B',
          choices: [
            {
              text: 'ç”Ÿåƒ',
              type: 'NORMAL',
              healthCost: 20,
              sanityCost: 10,
              effect: (s) => ({ health: s.health - 20, sanity: s.sanity - 10 }),
              resultText: 'ä½ åƒä¸‹å»äº†ï¼Œç„¶åå¼€å§‹å‘•åã€‚ä½ çš„è§†é‡å˜æˆäº†ç´«è‰²ï¼Œçœ‹è§äº†è¿‡ä¸–çš„å¥¶å¥¶ã€‚',
            },
            {
              text: '[é“èƒƒ] å˜å˜£è„†',
              type: 'TALENT',
              talentReq: 'T01',
              healthCost: -10,
              effect: (s) => ({ health: s.health + 10, sanity: s.sanity + 5 }),
              resultText: 'é¸¡è‚‰å‘³ï¼Œå˜å˜£è„†ã€‚è›‹ç™½è´¨æ˜¯ç‰›è‚‰çš„äº”å€ã€‚',
            }
          ]
        },
        // ROUTE C
        {
          id: 'C02_PIZZA',
          title: 'æœ€åçš„æŠ«è¨',
          description: 'ä½ è¯•å›¾ç‚¹å¤–å–é€åˆ°ç§˜å¯†åŸºåœ°é—¨å£ã€‚å¤–å–å°å“¥æ¥å•äº†ï¼Œä½†ä»–åŒæ—¶ä¹ŸæŠŠåæ ‡å–ç»™äº†CIAã€‚',
          tags: ['FOOD', 'DANGER'],
          route: 'C',
          choices: [
            {
              text: 'å‡ºå»æ‹¿å¤–å–',
              type: 'AGGRESSIVE',
              healthCost: -10,
              effect: (s) => ({ risk: s.risk + 30, health: s.health + 10 }),
              resultText: 'ä½ æ‹¿åˆ°äº†æŠ«è¨ï¼Œäº”åˆ†é’Ÿåï¼Œæˆ˜æ–§å¯¼å¼¹çš„å¤–å–ä¹Ÿåˆ°äº†ã€‚åŸºåœ°é˜²å¾¡å—æŸã€‚',
            },
            {
              text: 'å–æ¶ˆè®¢å•',
              type: 'SAFE',
              healthCost: 5,
              sanityCost: 10,
              effect: (s) => ({ sanity: s.sanity - 10, health: s.health - 5 }),
              resultText: 'ä½ é¥¿ç€è‚šå­å¬ç€è‚šå­å«ã€‚è¿™æ˜¯æœ€å®‰å…¨çš„é¥¿è‚šå­ã€‚',
            }
          ]
        },
        {
          id: 'C04_LOYALTY',
          title: 'å°†å†›çš„åŠ è–ªè¦æ±‚',
          description: 'å«é˜Ÿé˜Ÿé•¿è¿›æ¥æ•¬äº†ä¸ªç¤¼ï¼Œè¯´å…„å¼Ÿä»¬å£«æ°”ä½è½ï¼Œè¦æ±‚ç”¨ç¾å…ƒç»“ç®—å·¥èµ„ï¼Œè€Œä¸”è¦ç°ç»“ã€‚',
          tags: ['MONEY', 'HUMAN'],
          route: 'C',
          choices: [
            {
              text: 'ç»™é’± ($50w)',
              type: 'NORMAL',
              moneyReq: 500000,
              effect: (s) => ({ money: s.money - 500000, risk: Math.max(0, s.risk - 10) }),
              resultText: 'æœ‰é’±èƒ½ä½¿é¬¼æ¨ç£¨ã€‚ä»–æ•¬ç¤¼çš„å§¿åŠ¿æ ‡å‡†å¤šäº†ã€‚',
            },
            {
              text: 'è°ˆç†æƒ³',
              type: 'AGGRESSIVE',
              healthCost: 20,
              effect: (s) => ({ risk: s.risk + 20, health: s.health - 20 }),
              resultText: 'â€œç†æƒ³ä¸èƒ½å½“é¥­åƒã€‚â€ä»–æœå¤©èŠ±æ¿å¼€äº†ä¸€æªã€‚ä½ å“å¾—å°¿äº†è£¤å­ã€‚',
            }
          ]
        },
        // LOW SANITY
        {
          id: 'S02_MIRROR',
          title: 'é•œå­é‡Œçš„é™Œç”Ÿäºº',
          description: 'ä½ ç…§é•œå­ï¼Œé•œå­é‡Œçš„äººæ²¡æœ‰èƒ¡å­ï¼Œç©¿ç€æ©™è‰²å›šæœï¼Œæ­£åœ¨çº½çº¦çš„ç›‘ç‹±é‡Œåƒä¸‰æ˜æ²»ã€‚',
          tags: ['DARK'],
          condition: (s) => s.sanity < 30,
          priority: 80,
          repeatable: true,
          choices: [
            {
              text: 'ç ¸ç¢é•œå­',
              type: 'AGGRESSIVE',
              healthCost: 5,
              effect: (s) => ({ health: s.health - 5, sanity: s.sanity + 5 }),
              resultText: 'æ‰‹è¢«åˆ’ç ´äº†ï¼Œä½†é‚£ä¸ªå›šçŠ¯æ¶ˆå¤±äº†ã€‚',
            },
            {
              text: 'é—®ä»–å¥½ä¸å¥½åƒ',
              type: 'NORMAL',
              sanityCost: 10,
              effect: (s) => ({ sanity: s.sanity - 10 }),
              resultText: 'ä»–ç¬‘äº†ç¬‘ï¼Œé€’ç»™ä½ åŠä¸ªä¸‰æ˜æ²»ã€‚ä½ ä¼¸æ‰‹å»æ‹¿ï¼Œæ’åˆ°äº†ç»ç’ƒã€‚',
            }
          ]
        },
      ];

      const ENDINGS = [
        {
          id: 'E_DEAD',
          title: 'å†å²çš„å°˜åŸƒ',
          description: 'ä½ å€’åœ¨äº†æ³¥æ³é‡Œã€‚æ²¡æœ‰è‘¬ç¤¼ï¼Œæ²¡æœ‰å›½æ——ã€‚åªæœ‰è·¯é€ç¤¾çš„ä¸€æ¡ç®€è®¯ï¼šâ€œçªå‘ï¼šå‰æ€»ç»Ÿè¢«ç¡®è®¤èº«äº¡ã€‚â€ä¸¤åˆ†é’Ÿåï¼Œè¿™æ¡æ–°é—»è¢«ä¸€æ¡â€œçŒ«å’ªè·³èˆâ€çš„è§†é¢‘é¡¶ä¸‹å»äº†ã€‚',
          condition: (s) => s.health <= 0
        },
        {
          id: 'E_EXTRADITION',
          title: 'å¼•æ¸¡ä¸“æœº',
          description: 'ä½ è¢«æˆ´ä¸Šäº†å¤´å¥—ã€‚ä½ é—»åˆ°äº†ç†Ÿæ‚‰çš„èˆªç©ºç‡ƒæ²¹å‘³ã€‚ç©ºå§ç”œç¾çš„å£°éŸ³å“èµ·ï¼šâ€œæ¬¢è¿ä¹˜åç¾è”èˆªï¼Œæœ¬æ¬¡èˆªç­ç›´é£çº½çº¦å—åŒºæ³•é™¢ã€‚â€',
          condition: (s) => s.risk >= 100
        },
        {
          id: 'E_INSANE',
          title: 'ç–¯äººé™¢æ¼”è®²',
          description: 'ç†æ™ºå½’é›¶ã€‚ä½ ååœ¨è·¯è¾¹å¯¹ç€ç©ºæ°”å‘è¡¨æ¼”è®²ã€‚è­¦å¯Ÿç”šè‡³æ²¡ç»™ä½ æˆ´æ‰‹é“ï¼Œåªæ˜¯æ¸©æŸ”åœ°ç»™ä½ æŠ«ä¸Šäº†æ¯›æ¯¯ï¼Œé€ä½ å»äº†è¯¥å»çš„åœ°æ–¹ã€‚',
          condition: (s) => s.sanity <= 0
        },
        {
          id: 'E_BROKE',
          title: 'è¡—å¤´ä¹ä¸',
          description: 'æ²¡é’±äº†ã€‚æ˜”æ—¥çš„ç‹¬è£è€…ï¼Œå¦‚ä»Šåœ¨å“¥ä¼¦æ¯”äºšè¡—å¤´å–ç‰ç±³é¥¼ã€‚è·¯äººçº·çº·æŠ•æ¥åŒæƒ…çš„ç¡¬å¸ï¼Œä½ å±…ç„¶è§‰å¾—æ¯”å½“æ€»ç»Ÿè½»æ¾ã€‚',
          condition: (s) => s.money < 0
        },
        {
          id: 'E_SUNRISE',
          title: 'æµ·å²›æ—¥å‡º',
          description: 'å°èˆ¹é å²¸äº†ã€‚è¿™ä¸ªå²›åœ¨åœ°å›¾ä¸Šä¸å­˜åœ¨ã€‚ä½ æ‹¿å‡ºä»…å‰©çš„é‡‘æ¡æ‰”ç»™èˆ¹å¤«ã€‚å¤ªé˜³å‡èµ·ï¼Œä½ ä¸å†æ˜¯æ€»ç»Ÿï¼Œä½ æ˜¯å²›ä¸»ã€‚ä½ æ´»ä¸‹æ¥äº†ã€‚',
          condition: (s) => s.time <= 0 && s.route === 'B'
        },
        {
          id: 'E_URBAN_LEGEND',
          title: 'éƒ½å¸‚ä¼ è¯´',
          description: 'æ²¡äººè§è¿‡ä»–ã€‚æœ‰äººè¯´ä»–åœ¨è´«æ°‘çªŸå½“äº†æ•™çˆ¶ï¼Œæœ‰äººè¯´ä»–æ•´å®¹æˆäº†éŸ©æµæ˜æ˜Ÿã€‚è­¦æ–¹ç¿»éäº†å…¨åŸï¼Œè¿ä¸€æ ¹èƒ¡å­éƒ½æ²¡æ‰¾åˆ°ã€‚',
          condition: (s) => s.time <= 0 && s.route === 'A'
        },
        {
          id: 'E_BUNKER_KING',
          title: 'åœ°åº•ä¹‹ç‹',
          description: '72å°æ—¶è¿‡å»äº†ï¼Œä»–ä»¬æ²¡èƒ½æ”»ç ´ä½ çš„å¤§é—¨ã€‚ä½ ååœ¨å †æ»¡ç½å¤´çš„ç‹åº§ä¸Šï¼Œè™½ç„¶åªæœ‰è€é¼ æ˜¯ä½ çš„è‡£æ°‘ï¼Œä½†ä½ ä¾ç„¶æ˜¯ç‹ã€‚',
          condition: (s) => s.time <= 0 && s.route === 'C'
        },
        {
          id: 'E_SURVIVE',
          title: 'ä¾¥å¹¸é€ƒè„±',
          description: 'è™½ç„¶å¾ˆç‹¼ç‹ˆï¼Œé‹å­è·‘ä¸¢äº†ï¼Œç§æˆ¿é’±ä¹Ÿæ²¡äº†ï¼Œä½†ä½ ç†¬è¿‡äº†æœ€åçš„72å°æ—¶ã€‚è‡ªç”±çš„ç©ºæ°”çœŸç”œç¾ã€‚',
          condition: (s) => s.time <= 0
        }
      ];

      // ==========================================
      // 3. COMPONENTS
      // ==========================================
      
      const TAG_CN = {
        CITY: 'åŸå¸‚', DANGER: 'å±æœº', DIGITAL: 'æ•°å­—', SOCIAL: 'ç¤¾äº¤',
        SCAM: 'è¯ˆéª—', FOOD: 'è¡¥ç»™', RESOURCE: 'èµ„æº', SKY: 'å¤©ç©º',
        HUMAN: 'äººæ€§', MECH: 'æœºæ¢°', MONEY: 'è´¢å¯Œ', SURVIVAL: 'ç”Ÿå­˜',
        NATURE: 'è‡ªç„¶', DARK: 'é»‘æš—', MYSTERY: 'ç¥ç§˜', TIME: 'æ—¶é—´'
      };

      const Button = ({ children, variant = 'primary', icon: Icon, fullWidth, className, route = 'NONE', ...props }) => {
        let bgClass = 'bg-white';
        let textClass = 'text-black';
        
        if (variant === 'primary') bgClass = 'bg-pop-yellow hover:bg-yellow-300';
        if (variant === 'secondary') bgClass = 'bg-white hover:bg-gray-50';
        if (variant === 'danger') bgClass = 'bg-pop-red text-white hover:bg-red-500';
        if (variant === 'special') bgClass = 'bg-pop-blue text-white hover:bg-blue-500';

        const [isPressed, setIsPressed] = useState(false);

        return (
          <button 
            className={`
              relative group font-rounded text-lg border-4 border-black transition-all duration-75
              ${fullWidth ? 'w-full' : ''} 
              px-4 py-3 flex items-center justify-between gap-3
              ${bgClass} ${textClass}
              ${isPressed ? 'translate-x-[4px] translate-y-[4px] shadow-none' : 'shadow-pop'}
              ${props.disabled ? 'opacity-50 cursor-not-allowed filter grayscale' : 'cursor-pointer'}
              rounded-lg
              ${className || ''}
            `}
            onMouseDown={() => setIsPressed(true)}
            onMouseUp={() => setIsPressed(false)}
            onMouseLeave={() => setIsPressed(false)}
            onTouchStart={() => setIsPressed(true)}
            onTouchEnd={() => setIsPressed(false)}
            {...props}
          >
            <div className="flex items-center gap-3 text-left w-full">
              {Icon && <div className="p-1 border-2 border-black bg-white/50 rounded-md shrink-0"><Icon size={20} className="text-black" /></div>}
              <span className="font-bold flex-1 leading-tight">{children}</span>
            </div>
          </button>
        );
      };

      const IconButton = ({ icon: Icon, onClick, className }) => {
        const [isPressed, setIsPressed] = useState(false);
        return (
          <button 
            onClick={onClick}
            onMouseDown={() => setIsPressed(true)}
            onMouseUp={() => setIsPressed(false)}
            onMouseLeave={() => setIsPressed(false)}
            onTouchStart={() => setIsPressed(true)}
            onTouchEnd={() => setIsPressed(false)} 
            className={`
              p-2 border-4 border-black bg-white text-black transition-all duration-75
              ${isPressed ? 'translate-x-[2px] translate-y-[2px] shadow-none' : 'shadow-pop-sm'}
              rounded-lg
              ${className}
            `}>
            <Icon size={24} strokeWidth={3} />
          </button>
        );
      };

      const Card = ({ children, className, title }) => (
        <div className={`relative bg-white border-4 border-black p-5 shadow-pop-lg rounded-xl ${className || ''}`}>
          <div className="absolute inset-0 opacity-10 pointer-events-none rounded-xl bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]"></div>
          {title && (
            <div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-pop-red text-white px-3 py-0.5 border-4 border-black font-cartoon text-lg tracking-wider rotate-[-2deg] z-20 whitespace-nowrap shadow-sm rounded-md">
              {title}
            </div>
          )}
          <div className="relative z-10 w-full">{children}</div>
        </div>
      );

      const ElBigotes = ({ route, sanity, health, action, isTransitioning, className }) => {
        const [blink, setBlink] = useState(false);
        useEffect(() => {
          const blinkInterval = setInterval(() => {
            setBlink(true);
            setTimeout(() => setBlink(false), 200);
          }, 3000 + Math.random() * 2000); 
          return () => clearInterval(blinkInterval);
        }, []);

        const isStressed = health < 50 || sanity < 50;
        const isCritical = health < 20 || sanity < 20;
        const isHurt = action === 'HURT';
        const isRich = action === 'RICH';
        const isSwitching = action === 'SWITCH';
        
        const shakeClass = isCritical || isHurt ? 'animate-shake' : '';
        const breathingStyle = isSwitching ? {} : { animation: 'breathe 4s ease-in-out infinite' };

        return (
          <div className={`relative w-40 h-48 ${shakeClass} ${className || ''}`} style={breathingStyle}>
            <style>{`
              @keyframes breathe {
                  0%, 100% { transform: scaleY(1) translateY(0); }
                  50% { transform: scaleY(1.02) translateY(-2px); }
              }
              @keyframes poof {
                  0% { transform: scale(0); opacity: 1; }
                  50% { opacity: 1; }
                  100% { transform: scale(2); opacity: 0; }
              }
            `}</style>
            
            {isSwitching && (
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 z-50 pointer-events-none">
                   <div className="absolute inset-0 bg-white rounded-full animate-[poof_0.6s_ease-out_forwards]"></div>
                   <div className="absolute top-0 left-0 w-20 h-20 bg-gray-200 rounded-full animate-[poof_0.5s_ease-out_0.1s_forwards]"></div>
                   <div className="absolute bottom-0 right-0 w-24 h-24 bg-gray-100 rounded-full animate-[poof_0.7s_ease-out_0.05s_forwards]"></div>
                   <div className="absolute top-0 right-0 text-4xl animate-bounce" style={{animationDuration: '0.3s'}}>ğŸ’¨</div>
              </div>
            )}

            {/* HEAD */}
            <div className={`
              absolute top-0 left-1/2 -translate-x-1/2 w-32 h-32 bg-[#e0ac69] border-4 border-black rounded-full z-20 flex flex-col items-center shadow-md
              ${isSwitching ? 'scale-0' : 'scale-100'} transition-transform duration-300
            `} style={{ boxShadow: 'inset -5px -5px 0px rgba(0,0,0,0.1)' }}>
                <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-[105%] h-16 bg-black rounded-t-full z-10" style={{ clipPath: 'ellipse(100% 100% at 50% 100%)' }}></div>
                <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-[90%] h-12 bg-black rounded-t-full z-10"></div>
                <div className="absolute top-14 -left-3 w-4 h-7 bg-[#e0ac69] border-4 border-black rounded-l-md z-0"></div>
                <div className="absolute top-14 -right-3 w-4 h-7 bg-[#e0ac69] border-4 border-black rounded-r-md z-0"></div>
                {isStressed && <div className="absolute top-10 right-2 text-blue-400 font-bold text-xl animate-pulse z-30">ğŸ’¦</div>}
                
                <div className="absolute top-10 w-full px-4 flex justify-between z-30 pointer-events-none mt-1">
                    <div className={`w-8 h-2.5 bg-black rounded-full transition-transform duration-500 ${isStressed || isHurt ? 'rotate-[20deg] translate-y-1' : 'rotate-0'}`}></div>
                    <div className={`w-8 h-2.5 bg-black rounded-full transition-transform duration-500 ${isStressed || isHurt ? '-rotate-[20deg] translate-y-1' : 'rotate-0'}`}></div>
                </div>

                <div className="flex gap-2 mt-14 relative z-20">
                    {isHurt ? (
                        <>
                            <div className="w-9 h-9 bg-white border-4 border-black rounded-full flex items-center justify-center font-bold text-lg">X</div>
                            <div className="w-9 h-9 bg-white border-4 border-black rounded-full flex items-center justify-center font-bold text-lg">X</div>
                        </>
                    ) : isRich ? (
                        <>
                            <div className="w-9 h-9 bg-green-100 border-4 border-black rounded-full flex items-center justify-center font-bold text-green-700">$</div>
                            <div className="w-9 h-9 bg-green-100 border-4 border-black rounded-full flex items-center justify-center font-bold text-green-700">$</div>
                        </>
                    ) : (
                        <>
                            <div className={`w-9 h-9 bg-white border-4 border-black rounded-full relative overflow-hidden ${isCritical ? 'bg-red-100' : ''}`}>
                                <div className={`absolute top-0 w-full bg-[#d49e5d] border-b-4 border-black z-20 transition-all duration-300 ${blink ? 'h-full' : isStressed ? 'h-1' : 'h-4'}`}></div>
                                <div className={`w-3 h-3 bg-black rounded-full absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${isCritical ? 'animate-ping' : ''}`}></div>
                            </div>
                            <div className={`w-9 h-9 bg-white border-4 border-black rounded-full relative overflow-hidden ${isCritical ? 'bg-red-100' : ''}`}>
                                <div className={`absolute top-0 w-full bg-[#d49e5d] border-b-4 border-black z-20 transition-all duration-300 ${blink ? 'h-full' : isStressed ? 'h-1' : 'h-4'}`}></div>
                                <div className={`w-3 h-3 bg-black rounded-full absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${isCritical ? 'animate-ping' : ''}`}></div>
                            </div>
                        </>
                    )}
                </div>

                <div className="w-4 h-2 rounded-full border-b-4 border-black/20 mt-1"></div>
                <div className={`relative z-30 mt-[-2px] ${isStressed || isHurt ? 'animate-shake' : ''}`}>
                   <div className="w-24 h-14 bg-black rounded-[40%] absolute left-1/2 -translate-x-1/2 -top-1"></div>
                </div>
                {isHurt && (
                    <div className="absolute top-16 left-2 w-8 h-3 bg-[#e8beac] border-2 border-black rotate-45 z-40 opacity-90 shadow-sm flex items-center justify-center">
                        <div className="w-1 h-1 bg-black/20 rounded-full mx-0.5"></div>
                        <div className="w-1 h-1 bg-black/20 rounded-full mx-0.5"></div>
                    </div>
                )}
                
                {/* HEADGEAR */}
                {route === 'A' && <div className="absolute -top-4 left-1/2 -translate-x-1/2 w-32 h-12 bg-red-600 border-4 border-black rounded-t-full skew-x-2 z-40 shadow-md flex items-end justify-center pb-1"><div className="text-white font-bold text-[10px] tracking-tighter">VENCEREMOS</div></div>}
                {route === 'B' && <div className="absolute -top-6 w-36 h-14 bg-[#4A5D23] border-4 border-black rounded-tl-full rounded-br-full -rotate-3 z-40 flex items-center justify-center shadow-md"><div className="w-full h-1 bg-black/20 absolute"></div><div className="w-1 h-full bg-black/20 absolute"></div></div>}
                {route === 'C' && <div className="absolute -top-8 w-36 h-16 bg-[#1a202c] border-4 border-black z-40 flex flex-col items-center shadow-md rounded-sm"><div className="w-full h-3 bg-red-600 mt-10 border-y-2 border-black"></div><div className="w-10 h-10 rounded-full bg-yellow-500 border-2 border-black absolute -top-4 shadow-sm flex items-center justify-center text-xs">â­</div></div>}
            </div>

            {/* BODY */}
            <div className={`
                absolute top-28 left-1/2 -translate-x-1/2 w-36 h-24 bg-white border-4 border-black rounded-[2rem] z-10 flex flex-col overflow-hidden shadow-pop-sm
                ${isSwitching ? 'scale-0' : 'scale-100'} transition-transform duration-300 delay-75
            `} style={{ boxShadow: 'inset -10px 0px 0px rgba(0,0,0,0.1)' }}>
                {route === 'A' && (
                    <div className="w-full h-full flex flex-col bg-[#00247D] relative">
                         <div className="w-full h-6 bg-transparent border-b-4 border-black relative z-10"></div>
                         <div className="absolute top-0 w-full h-full flex flex-col">
                             <div className="flex-1 bg-yellow-400 border-b-4 border-black"></div>
                             <div className="flex-1 bg-blue-600 border-b-4 border-black flex justify-center items-center">
                                 <div className="flex gap-1"><div className="w-1 h-1 bg-white rounded-full"></div><div className="w-1 h-1 bg-white rounded-full"></div><div className="w-1 h-1 bg-white rounded-full"></div><div className="w-1 h-1 bg-white rounded-full"></div></div>
                             </div>
                             <div className="flex-1 bg-red-600"></div>
                         </div>
                         <div className="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-full bg-black/10 border-x-2 border-black/10"></div>
                    </div>
                )}
                {route === 'B' && (
                    <div className="w-full h-full bg-[#E5E5E5] relative">
                        <div className="absolute top-4 left-4 w-6 h-6 bg-[#8D6E63] rounded-full opacity-60 filter blur-sm"></div>
                        <div className="absolute bottom-2 right-6 w-8 h-8 bg-[#8D6E63] rounded-full opacity-60 filter blur-sm"></div>
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 flex flex-col gap-4 pt-2"><div className="w-2 h-2 bg-black rounded-full opacity-50"></div><div className="w-2 h-2 bg-black rounded-full opacity-50"></div></div>
                    </div>
                )}
                {route === 'C' && (
                    <div className="w-full h-full bg-[#1F2937] relative flex flex-col items-center">
                        <div className="absolute top-0 right-0 w-12 h-full bg-gradient-to-r from-yellow-400 via-blue-500 to-red-600 border-l-4 border-black transform -skew-x-12 origin-top shadow-md z-10 opacity-90"></div>
                        <div className="absolute top-8 left-4 flex flex-wrap w-16 gap-1"><div className="w-4 h-2 bg-yellow-400 border border-black"></div><div className="w-4 h-2 bg-red-500 border border-black"></div><div className="w-4 h-2 bg-white border border-black"></div><div className="w-4 h-2 bg-green-600 border border-black"></div></div>
                    </div>
                )}
                {route === 'NONE' && (
                    <div className="w-full h-full bg-[#1e293b] flex flex-col items-center relative">
                        <div className="w-0 h-0 border-l-[14px] border-l-transparent border-r-[14px] border-r-transparent border-t-[24px] border-t-[#d49e5d] mt-0 z-10"></div>
                        <div className="w-8 h-full bg-red-700 absolute top-0 z-0 border-x-2 border-black/30"></div>
                        <div className="absolute top-8 left-4 w-8 h-1 bg-black/30 rounded-full border border-black/20"></div>
                        <div className="absolute top-8 right-4 w-6 h-8 bg-white border border-black -rotate-6 opacity-80 shadow-sm flex flex-col items-center p-0.5"><div className="w-4 h-4 bg-gray-300 rounded-sm mb-0.5"></div><div className="w-4 h-0.5 bg-black/50"></div></div>
                    </div>
                )}
            </div>

            <div className={`absolute top-36 -left-2 w-12 h-20 bg-[#e0ac69] border-4 border-black rounded-b-full origin-top -rotate-6 z-0 shadow-sm ${isSwitching ? 'scale-0' : 'scale-100'} transition-transform duration-300`}></div>
            <div className={`absolute top-36 -right-2 w-12 h-20 bg-[#e0ac69] border-4 border-black rounded-b-full origin-top rotate-6 z-0 shadow-sm ${isSwitching ? 'scale-0' : 'scale-100'} transition-transform duration-300`}></div>
            {route === 'A' && <div className="absolute top-44 -left-6 text-4xl -rotate-12 z-20 drop-shadow-md">ğŸ•Šï¸</div>}
          </div>
        );
      };

      const Avatar = ({ health, sanity }) => {
        let emoji = "ğŸ˜"; 
        let bg = "bg-pop-green";
        if (health < 50 || sanity < 50) { emoji = "ğŸ˜°"; bg = "bg-pop-yellow"; }
        if (health < 20 || sanity < 20) { emoji = "ğŸ˜µâ€ğŸ’«"; bg = "bg-pop-red"; }
        return <div className={`w-12 h-12 ${bg} border-4 border-black rounded-full flex items-center justify-center text-2xl shadow-pop overflow-hidden shrink-0`}>{emoji}</div>;
      };

      const BossScene = ({ tags, isTransitioning, riskLevel, route = 'NONE', sanity, health, action }) => {
        const isBunker = route === 'C';
        const isJungle = route === 'B';
        const isBarrio = route === 'A';
        const isHurt = action === 'HURT';
        let bgClass = 'bg-pop-cream';
        if (isBarrio) bgClass = 'bg-yellow-100';
        if (isJungle) bgClass = 'bg-green-100';
        if (isBunker) bgClass = 'bg-gray-300';
        if (isHurt) bgClass = 'bg-red-200';

        return (
          <div className={`relative w-full h-64 border-4 border-black shadow-pop-lg overflow-hidden transition-colors duration-200 rounded-xl ${bgClass}`}>
             <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
             <div className="absolute top-4 right-4 text-pop-yellow animate-spin-slow"><Sun size={48} strokeWidth={3} fill="#FFD166" className="text-black" /></div>
             <div className="absolute bottom-0 w-full h-12 bg-black/10 border-t-4 border-black"></div>
             <div className="absolute bottom-4 left-1/2 -translate-x-1/2 z-20"><ElBigotes route={route} sanity={sanity} health={health} action={action} isTransitioning={isTransitioning} /></div>
             {riskLevel > 50 && <div className="absolute top-10 left-10 animate-bounce text-4xl">ğŸš”</div>}
             <div className="absolute bottom-2 left-2 flex flex-wrap gap-2 z-30">{tags.map(t => <span key={t} className="bg-white border-2 border-black px-2 py-0.5 text-xs font-bold shadow-pop-sm rotate-[-2deg] rounded-sm">#{TAG_CN[t] || t}</span>)}</div>
          </div>
        );
      };

      const DanmakuOverlay = () => {
        const comments = ["å®Œäº†å®Œäº†", "èŠ­æ¯”Qäº†", "SANå€¼ç‹‚æ‰", "è¿™æ˜¯ä¸ªå•¥ï¼Ÿ", "æˆ‘è¦å›å®¶", "å‰é¢çš„åˆ«è·‘", "???", "å‰æ–¹é«˜èƒ½"];
        return (
          <div className="absolute inset-0 pointer-events-none overflow-hidden z-50 opacity-60">
              {comments.map((text, i) => (
                  <div key={i} className="absolute whitespace-nowrap text-2xl font-cartoon text-red-600 animate-danmaku" style={{ top: `${Math.random() * 80 + 10}%`, animationDuration: `${Math.random() * 5 + 5}s`, animationDelay: `${Math.random() * 5}s` }}>{text}</div>
              ))}
          </div>
        );
      };

      const ResultCard = ({ text, deltas, route = 'NONE' }) => {
        const STAT_CN = { 'money': 'èµ„é‡‘', 'risk': 'æ›å…‰åº¦', 'sanity': 'ç†æ™º', 'health': 'å¥åº·', 'time': 'æ—¶é—´', 'fans': 'ç²‰ä¸', 'karma': 'å–„æ¶' };
        return (
          <div className={`w-full bg-white border-4 border-black p-6 relative animate-jelly shadow-pop-lg rounded-xl`}>
             <div className="absolute inset-0 opacity-10 pointer-events-none rounded-xl bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]"></div>
             <div className="absolute -top-4 -right-4 text-4xl animate-bounce z-20">{deltas.money && deltas.money > 0 ? 'ğŸ’°' : deltas.risk && deltas.risk > 0 ? 'ğŸ“¢' : 'ğŸ“'}</div>
             <h3 className="font-cartoon text-2xl mb-4 border-b-4 border-black inline-block relative z-10">æœ€æ–°æƒ…æŠ¥</h3>
             <div className="flex flex-wrap gap-2 mb-4 relative z-10">
                 {Object.entries(deltas).map(([key, val]) => {
                     if (!val) return null;
                     const isPos = val > 0;
                     const isBad = (key === 'risk' && isPos) || (key !== 'risk' && !isPos);
                     return <div key={key} className={`flex items-center gap-2 border-2 border-black px-3 py-1 font-bold ${isBad ? 'bg-pop-red text-white' : 'bg-pop-green text-black'} shadow-pop-sm rounded-lg text-sm`}><span>{STAT_CN[key] || key}</span><span>{isPos ? '+' : ''}{val}</span></div>
                 })}
             </div>
             <p className="font-sans text-lg leading-relaxed text-black font-medium relative z-10">{text}</p>
          </div>
        );
      };

      // ==========================================
      // 4. MAIN APP LOGIC
      // ==========================================

      const INITIAL_STATS = {
        time: 72, money: 5000000, risk: 10, sanity: 100, health: 100, karma: 0, fans: 0,
        route: 'NONE', talents: [], flags: {}, seenEvents: [], history: [{ turn: 0, risk: 10, money: 5000000, sanity: 100, health: 100 }], eventCount: 0,
      };

      const NEWS_TICKER = [
          "çªå‘ï¼šæ€»ç»Ÿåºœé­é‡ä¸æ˜åŸå› æ–­ç”µ...",
          "å¸‚åœºä¼ é—»ï¼šä»¥å¤ªåŠæš´è·Œ 20%...",
          "å¤©æ°”é¢„æŠ¥ï¼šçƒ­å¸¦é£æš´å³å°†ç™»é™†...",
          "çƒ­æœç¬¬ä¸€ï¼š'ä»–å»å“ªäº†ï¼Ÿ'...",
          "æš—ç½‘æ‚¬èµï¼šå‰æ€»ç»Ÿè¡Œè¸ªä»·å€¼ $100w...",
      ];

      const formatMoney = (amount) => Math.abs(amount) >= 10000 ? `${(amount / 10000).toFixed(1)}w` : `${amount}`;
      const formatCount = (amount) => Math.abs(amount) >= 10000 ? `${(amount / 10000).toFixed(1)}w` : `${amount}`;
      const getRandomElements = (arr, count) => [...arr].sort(() => 0.5 - Math.random()).slice(0, count);

      function App() {
        const [phase, setPhase] = useState(GamePhase.START);
        const [stats, setStats] = useState(INITIAL_STATS);
        const [currentEvent, setCurrentEvent] = useState(null);
        const [availableTalents, setAvailableTalents] = useState([]);
        const [lastResult, setLastResult] = useState(null);
        const [lastDeltas, setLastDeltas] = useState({});
        const [ending, setEnding] = useState(null);
        const [isTransitioning, setIsTransitioning] = useState(false);
        const [characterAction, setCharacterAction] = useState('IDLE');
        const [showSettings, setShowSettings] = useState(false);
        const [tickerIndex, setTickerIndex] = useState(0);

        useEffect(() => {
          const timer = setInterval(() => setTickerIndex(prev => (prev + 1) % NEWS_TICKER.length), 5000);
          return () => clearInterval(timer);
        }, []);

        const getAppBackground = () => {
            if (stats.sanity < 20) return 'bg-black';
            if (stats.sanity < 50) return 'bg-[#2D3748]';
            return 'bg-pop-blue';
        };

        const startGame = () => {
          setStats(INITIAL_STATS);
          setAvailableTalents(getRandomElements(TALENTS, 3));
          setLastResult(null);
          setLastDeltas({});
          setEnding(null);
          setCharacterAction('IDLE');
          setPhase(GamePhase.TALENT_SELECT);
        };

        const selectTalent = (talent) => {
          let newStats = { ...stats, talents: [...stats.talents, talent.id] };
          if (talent.id === 'T05') newStats.money = 20000000;
          if (talent.id === 'T18') newStats.money = 10000000; 
          if (talent.id === 'T02') newStats.sanity -= 30;
          if (talent.id === 'T12') newStats.risk = Math.max(0, newStats.risk - 20);
          setStats(newStats);
          setPhase(GamePhase.GAME_LOOP);
          nextEvent(newStats);
        };

        const nextEvent = (currentStats) => {
          const matchedEnding = ENDINGS.find(e => e.condition(currentStats));
          if (matchedEnding) {
              setEnding(matchedEnding);
              setPhase(GamePhase.GAME_OVER);
              return;
          }
          const validEvents = EVENTS.filter(e => {
              const condMet = e.condition ? e.condition(currentStats) : true;
              const notSeen = e.repeatable || !currentStats.seenEvents.includes(e.id);
              const routeMatch = !e.route || e.route === currentStats.route;
              return condMet && notSeen && routeMatch;
          });

          if (validEvents.length === 0) {
              if (currentStats.time <= 0) {
                  setEnding(ENDINGS.find(e => e.id === 'E_SURVIVE'));
                  setPhase(GamePhase.GAME_OVER);
              } else {
                  const fallbackEvent = EVENTS.find(e => e.id === 'U01_HUNGRY');
                  setCurrentEvent(fallbackEvent || EVENTS[0]); 
              }
              return;
          }
          validEvents.sort((a, b) => (b.priority || 0) - (a.priority || 0));
          const topPriority = validEvents[0].priority || 0;
          const pool = validEvents.filter(e => (e.priority || 0) === topPriority);
          setCurrentEvent(pool[Math.floor(Math.random() * pool.length)]);
        };

        const handleChoice = (choiceIndex) => {
          if (!currentEvent) return;
          const choice = currentEvent.choices[choiceIndex];
          const changes = choice.effect(stats);
          
          if (stats.talents.includes('T05')) changes.money = (changes.money || 0) + (stats.money - 100000 - stats.money);
          if (stats.talents.includes('T19')) changes.time = (changes.time || 0) - 0.5;
          if (stats.talents.includes('T08') && changes.money && changes.money < 0) changes.money = Math.floor(changes.money * 0.8);

          const newStats = {
            ...stats, ...changes,
            eventCount: stats.eventCount + 1,
            flags: choice.setFlag ? { ...stats.flags, [choice.setFlag]: true } : stats.flags,
            route: choice.setRoute || stats.route,
            seenEvents: [...stats.seenEvents, currentEvent.id],
          };
          
          newStats.risk = Math.max(0, Math.min(100, newStats.risk || 0));
          newStats.sanity = Math.max(0, Math.min(100, newStats.sanity || 0));
          newStats.health = Math.max(0, Math.min(100, newStats.health || 0));
          newStats.time = Math.max(0, newStats.time || 0);

          newStats.history = [...stats.history, { 
            turn: newStats.eventCount, risk: newStats.risk, money: newStats.money, sanity: newStats.sanity, health: newStats.health
          }];

          const deltas = {
              money: (newStats.money - stats.money) || 0,
              risk: (newStats.risk - stats.risk) || 0,
              sanity: (newStats.sanity - stats.sanity) || 0,
              health: (newStats.health - stats.health) || 0,
              karma: (newStats.karma - stats.karma) || 0,
              fans: (newStats.fans - stats.fans) || 0,
              time: (newStats.time - stats.time) || 0,
          };

          setStats(newStats);
          setLastResult(choice.resultText);
          setLastDeltas(deltas);
          setIsTransitioning(true);

          let nextAction = 'IDLE';
          if (choice.setRoute && choice.setRoute !== stats.route) nextAction = 'SWITCH';
          else if (deltas.health && deltas.health < 0) nextAction = 'HURT';
          else if (deltas.money && deltas.money > 0) nextAction = 'RICH';
          setCharacterAction(nextAction);

          setTimeout(() => {
              setLastResult(null);
              setIsTransitioning(false); 
              setCharacterAction('IDLE');
              nextEvent(newStats);
          }, 1500); 
        };

        return (
          <div className={`fixed inset-0 w-full h-full font-sans overflow-hidden transition-colors duration-1000 ${getAppBackground()} ${stats.sanity < 50 ? 'text-white' : 'text-pop-dark'}`}>
              <div className="absolute inset-0 opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')] z-10"></div>
              {phase === GamePhase.START && (
                <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
                  <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[200vmax] h-[200vmax] animate-spin-slow opacity-10" style={{ background: 'conic-gradient(from 0deg, #FDF6E3 0deg 15deg, transparent 15deg 30deg)', backgroundImage: 'repeating-conic-gradient(#fff 0deg 15deg, transparent 15deg 30deg)' }}></div>
                </div>
              )}
              {stats.sanity < 30 && <DanmakuOverlay />}

              <div className="relative z-20 w-full h-full max-w-md mx-auto flex flex-col shadow-2xl bg-white/10 backdrop-blur-sm border-x-4 border-black">
                  
                  {showSettings && (
                      <div className="absolute inset-0 z-[100] bg-black/80 flex items-center justify-center p-6 animate-fade-in">
                          <Card title="æš‚åœ" className="w-full">
                              <div className="space-y-4">
                                  <Button onClick={() => { setPhase(GamePhase.START); setShowSettings(false); }} variant="danger" icon={LogOut} fullWidth>æ”¾å¼ƒæ²»ç–—</Button>
                                  <Button onClick={() => setShowSettings(false)} icon={X} fullWidth>ç»§ç»­è·‘è·¯</Button>
                              </div>
                          </Card>
                      </div>
                  )}

                  {phase === GamePhase.START && (
                      <div className="flex-1 flex flex-col items-center justify-center p-6 space-y-8 animate-fade-in overflow-y-auto">
                          <div className="relative bg-[#FDF6E3] border-4 border-black p-4 pb-8 shadow-pop-lg rotate-[-2deg] w-full max-w-xs transform hover:rotate-0 transition-transform duration-300">
                              <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-8 bg-yellow-200/80 rotate-1 transform skew-x-12 z-10"></div>
                              <div className="text-center border-b-4 border-black pb-2 mb-4">
                                  <h1 className="font-cartoon text-5xl text-pop-red tracking-widest text-shadow-sm">é€šç¼‰</h1>
                                  <div className="font-bold tracking-[0.5em] text-sm">WANTED</div>
                              </div>
                              <div className="bg-pop-blue/20 border-4 border-black p-4 mb-4 relative overflow-hidden h-48 flex items-end justify-center">
                                   <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/grid-noise.png')] opacity-20"></div>
                                   <ElBigotes route="NONE" health={100} sanity={100} isTransitioning={false} action="IDLE" className="scale-75 origin-bottom" />
                              </div>
                              <div className="text-center mb-4">
                                   <div className="font-cartoon text-4xl text-black leading-none break-words">å²›ä¸»åˆ«è·‘</div>
                                   <div className="text-xs font-bold mt-1 bg-black text-white inline-block px-2 rotate-2">DEAD OR ALIVE</div>
                              </div>
                              <div className="flex justify-between items-center font-bold font-mono text-sm border-t-2 border-black pt-2"><span>REWARD:</span><span className="text-xl">$5,000,000</span></div>
                          </div>
                          <div className="w-full max-w-xs space-y-4">
                              <Button onClick={startGame} fullWidth icon={Play} variant="primary" className="text-xl py-4 shadow-pop-lg">å¼€å§‹é€ƒäº¡</Button>
                              <Button onClick={() => setPhase(GamePhase.TALENT_INDEX)} fullWidth variant="secondary" icon={Database}>æƒ…æŠ¥æ•°æ®åº“</Button>
                          </div>
                      </div>
                  )}

                  {phase === GamePhase.TALENT_SELECT && (
                      <div className="flex-1 flex flex-col p-4 bg-pop-cream">
                          <header className="mb-4 text-center"><h2 className="text-2xl font-cartoon text-pop-blue">é€‰æ‹©ä½ çš„å¤–æŒ‚</h2></header>
                          <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                              {availableTalents.map((t, i) => (
                                  <div key={t.id} onClick={() => selectTalent(t)} className="cursor-pointer group transform transition-all duration-200 hover:scale-[1.02]">
                                      <Card className={`!p-3 h-auto min-h-0 hover:bg-yellow-50 group-active:scale-[0.98] ${t.rarity === 'LEGENDARY' ? 'bg-yellow-100' : ''}`} title={t.rarity === 'LEGENDARY' ? 'ä¼ è¯´' : ''}>
                                          <div className="flex items-start gap-3">
                                              <div className="p-1.5 border-2 border-black bg-pop-blue text-white rounded-lg shrink-0 mt-0.5"><Zap size={18} /></div>
                                              <div><div className="font-bold text-base text-black mb-0.5">{t.name}</div><div className="text-xs opacity-80 font-medium text-gray-700 leading-snug text-justify">{t.description}</div></div>
                                          </div>
                                      </Card>
                                  </div>
                              ))}
                          </div>
                      </div>
                  )}

                  {phase === GamePhase.TALENT_INDEX && (
                      <div className="flex-1 flex flex-col bg-pop-cream h-full">
                          <div className="p-4 border-b-4 border-black flex justify-between items-center bg-pop-yellow sticky top-0 z-20 shadow-pop">
                              <div className="flex items-center gap-2"><Database size={24} className="text-black" /><h2 className="text-xl font-cartoon text-black">æƒ…æŠ¥æ•°æ®åº“</h2></div>
                              <IconButton icon={ArrowLeft} onClick={() => setPhase(GamePhase.START)} className="bg-white" />
                          </div>
                          <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 gap-3 pb-20">
                              {TALENTS.map((t) => (
                                  <Card key={t.id} className={`${t.rarity === 'LEGENDARY' ? 'bg-yellow-50' : ''} h-fit min-h-0 !p-3`}>
                                      <div className="flex gap-3 items-start">
                                          <div className={`p-1.5 border-2 border-black rounded-lg shrink-0 mt-0.5 ${t.rarity === 'LEGENDARY' ? 'bg-pop-yellow' : 'bg-gray-200'}`}><Zap size={18} className="text-black" /></div>
                                          <div className="flex-1"><div className="font-bold text-base mb-0.5 text-black flex items-center justify-between">{t.name}{t.rarity === 'LEGENDARY' && <span className="text-[10px] bg-pop-red text-white px-1 border border-black rotate-3">ä¼ è¯´</span>}</div><div className="text-xs text-gray-800 font-medium leading-snug text-balance text-justify">{t.description}</div></div>
                                      </div>
                                  </Card>
                              ))}
                          </div>
                      </div>
                  )}

                  {phase === GamePhase.GAME_LOOP && (
                      <div className="flex-1 flex flex-col h-full overflow-hidden">
                          
                          {/* TOP HUD (V4: Compact 2 Rows) */}
                          <div className="bg-white border-b-4 border-black p-3 flex items-center justify-between shadow-pop z-30 sticky top-0">
                              
                              {/* LEFT: Avatar + Day + Time */}
                              <div className="flex items-center gap-3">
                                  <div className="relative"><Avatar health={stats.health} sanity={stats.sanity} /><div className="absolute -bottom-2 -right-2 bg-black text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold border border-white">D{Math.floor((72 - stats.time)/24) + 1}</div></div>
                                  <div className="flex flex-col"><div className="text-xs font-bold text-gray-500 uppercase tracking-wider">å‰©ä½™æ—¶é—´</div><div className="flex items-center gap-1 text-black"><Clock size={16} strokeWidth={3} /><span className="font-cartoon text-xl leading-none">{Math.ceil(stats.time)}h</span></div></div>
                              </div>
                              
                              {/* RIGHT: Stats Grid (Compact 3 cols x 2 rows) */}
                              <div className="grid grid-cols-3 gap-x-2 gap-y-2">
                                  
                                  {/* Row 1: Money, Health, Karma */}
                                  <div className="flex flex-col items-end">
                                      <div className="flex items-center justify-end gap-1.5 text-pop-green"><DollarSign size={14} strokeWidth={3} /><span className="font-bold text-sm leading-none">{formatMoney(stats.money)}</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">èµ„é‡‘</div>
                                  </div>

                                  <div className="flex flex-col items-end">
                                      <div className={`flex items-center justify-end gap-1.5 ${stats.health < 30 ? 'text-pop-red animate-pulse' : 'text-pop-red'}`}><Heart size={14} strokeWidth={3} fill={stats.health < 30 ? "currentColor" : "none"} /><span className="font-bold text-sm leading-none">{stats.health}</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">å¥åº·</div>
                                  </div>

                                  <div className="flex flex-col items-end">
                                      <div className={`flex items-center justify-end gap-1.5 ${stats.karma > 0 ? 'text-pop-green' : stats.karma < 0 ? 'text-pop-red' : 'text-gray-500'}`}><Scale size={14} strokeWidth={3} /><span className="font-bold text-sm leading-none">{stats.karma}</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">å–„æ¶</div>
                                  </div>

                                  {/* Row 2: Fans, Sanity, Risk */}
                                  <div className="flex flex-col items-end">
                                      <div className="flex items-center justify-end gap-1.5 text-pop-blue"><Users size={14} strokeWidth={3} /><span className="font-bold text-sm leading-none">{formatCount(stats.fans)}</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">ç²‰ä¸</div>
                                  </div>

                                  <div className="flex flex-col items-end">
                                      <div className={`flex items-center justify-end gap-1.5 ${stats.sanity < 30 ? 'text-purple-600 animate-pulse' : 'text-pop-blue'}`}><Brain size={14} strokeWidth={3} /><span className="font-bold text-sm leading-none">{stats.sanity}</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">ç†æ™º</div>
                                  </div>

                                  <div className="flex flex-col items-end">
                                      <div className={`flex items-center justify-end gap-1.5 ${stats.risk > 50 ? 'text-orange-600' : 'text-orange-500'}`}><Eye size={14} strokeWidth={3} /><span className="font-bold text-sm leading-none">{stats.risk}%</span></div>
                                      <div className="text-[10px] font-bold text-gray-400 mt-0.5">æ›å…‰</div>
                                  </div>
                              </div>
                          </div>

                          <div className="flex-1 overflow-y-auto p-4 relative z-20 space-y-4">
                              <BossScene tags={currentEvent?.tags || []} isTransitioning={isTransitioning} riskLevel={stats.risk} route={stats.route} sanity={stats.sanity} health={stats.health} action={characterAction} />
                              <div className="space-y-4 min-h-[300px]">
                                  {lastResult ? (
                                      <ResultCard text={lastResult} deltas={lastDeltas} route={stats.route} />
                                  ) : (
                                      <div className="animate-fade-in">
                                          <Card className="mb-4 bg-white"><h3 className="font-cartoon text-2xl mb-2 text-pop-blue">{currentEvent?.title}</h3><p className="font-sans text-lg font-medium leading-relaxed text-gray-800">{currentEvent?.description}</p></Card>
                                          <div className="space-y-3">
                                              {currentEvent?.choices.map((choice, idx) => {
                                                  const locked = (choice.moneyReq && stats.money < choice.moneyReq) || (choice.talentReq && !stats.talents.includes(choice.talentReq));
                                                  if (choice.type === 'TALENT' && locked) return null;
                                                  let variant = 'secondary';
                                                  if (choice.type === 'AGGRESSIVE') variant = 'danger';
                                                  if (choice.type === 'SPECIAL') variant = 'special';
                                                  if (choice.type === 'TALENT') variant = 'primary';
                                                  return (
                                                      <Button key={idx} onClick={() => handleChoice(idx)} disabled={locked} variant={variant} fullWidth>
                                                          <div className="flex justify-between w-full items-center">
                                                              <span>{choice.text}</span>
                                                              <div className="flex items-center gap-1">
                                                                  {choice.healthCost && <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${choice.healthCost > 0 ? 'bg-pop-red text-white' : 'bg-pop-green text-white'}`}>{choice.healthCost > 0 ? '-' : '+'}{Math.abs(choice.healthCost)} HP</span>}
                                                                  {choice.moneyReq && <span className="text-xs font-bold bg-black text-white px-2 py-0.5 rounded-full">-${choice.moneyReq}</span>}
                                                              </div>
                                                          </div>
                                                      </Button>
                                                  );
                                              })}
                                          </div>
                                      </div>
                                  )}
                              </div>
                          </div>

                          <div className="bg-pop-yellow border-t-4 border-black py-1 px-2 z-30 flex items-center justify-between h-12">
                              <div className="font-cartoon text-black mr-2 text-lg">å¿«è®¯:</div>
                              <div className="flex-1 overflow-hidden relative h-full flex items-center"><div className="text-sm font-bold whitespace-nowrap marquee">{NEWS_TICKER[tickerIndex]}</div></div>
                              <IconButton icon={Settings} onClick={() => setShowSettings(true)} className="scale-75 origin-right bg-white" />
                          </div>
                      </div>
                  )}

                  {phase === GamePhase.GAME_OVER && (
                      <div className="flex-1 flex flex-col items-center justify-center p-6 bg-black/90">
                          <Card title="GAME OVER" className="w-full max-w-md space-y-6 bg-white border-8 border-pop-red">
                              <div className="text-center space-y-4 border-b-4 border-black pb-4">
                                  <div className="text-6xl animate-bounce">{ending?.id.includes('SURVIVE') || ending?.id.includes('KING') || ending?.id.includes('SUNRISE') ? 'ğŸ†' : 'â˜ ï¸'}</div>
                                  <h2 className="font-cartoon text-3xl text-black uppercase">{ending?.title}</h2>
                              </div>
                              <p className="font-sans text-lg text-justify font-bold text-gray-800">{ending?.description}</p>
                              <div className="h-40 bg-gray-100 border-4 border-black p-2 relative">
                                   <ResponsiveContainer width="100%" height="100%">
                                      <AreaChart data={stats.history}>
                                          <Area type="monotone" dataKey="risk" stroke="#EF476F" strokeWidth={3} fill="#EF476F" fillOpacity={0.3} />
                                          <Area type="monotone" dataKey="sanity" stroke="#073B4C" strokeWidth={3} fill="#073B4C" fillOpacity={0.3} />
                                      </AreaChart>
                                  </ResponsiveContainer>
                              </div>
                              <Button onClick={startGame} fullWidth variant="primary" icon={RefreshCw}>å†æ¥ä¸€å±€</Button>
                          </Card>
                      </div>
                  )}
              </div>
          </div>
        );
      }

      // 5. MOUNT
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>